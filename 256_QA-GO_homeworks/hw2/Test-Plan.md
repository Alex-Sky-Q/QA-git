# Базовый тест-план - gRPC

Предварительные условия:

- Система запущена, проходит Readiness probe

## 1. ActDeviceApiService

### Тест 1.1. Создание и просмотр устройства

| Шаг | Действие                                                                                                              | Ожидаемый результат                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ------ | ----------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1      | Отправить запрос `CreateDeviceV1` со след. параметрами:<br />`userId: 1, platform: 'ios'` | - Пришел ответ `CreateDeviceV1Response` с `deviceId > 0 (deviceId_1)`<br />- В БД в табл. `devices` появилась запись: `id=deviceId_1, platform='ios', user_id=1, entered_at >= {Текущее время} (time_dev_1), removed=false, created_at >= entered_at, updated_at >= created_at`<br />- В БД в табл. `devices_events` появилась запись: `id={int} (event_ID_1), device_id=deviceId_1, type=1, status=1, payload={JSON}, created_at >= {Текущее время} (time_dev_1), updated_at >= created_at`<br />- После отправки события в Kafka в табл. `devices_events` запись `id=event_ID_1` обновляется на `status=2` |
| 2      | Отправить запрос `DescribeDeviceV1` с параметрами:<br />`deviceId: deviceId_1`                 | Пришел ответ `DescribeDeviceV1Response`:<br />`value {id: deviceId_1, platform: 'ios', userId: 1, enteredAt: ± time_dev_1}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |

### Тест 1.2. Редактирование существующего устройства

Предв. условия: устройство создано (выполнен Тест 1.1 - Создание устройства)

| Шаг | Действие                                                                                                                                                                         | Ожидаемый результат                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1      | Отправить запрос `UpdateDeviceV1` для редактирования устройства из теста 1.1:<br />`id: deviceId_1, platform: 'android', userId: 2` | - Пришел ответ `UpdateDeviceV1Response`:<br />`success: True`<br />- В БД в табл. `devices` обновлена запись `id=deviceId_1`: `platform='android', user_id=2, updated_at >= {Текущее время} (time_dev_2)`<br />- В БД в табл. `devices_events` появилась запись: `id={int} (event_ID_2), device_id=deviceId_1, type=2, status=1, payload={JSON}, created_at >= {Текущее время} (time_dev_2), updated_at >= created_at`<br />- После отправки события в Kafka  в табл. `devices_events` запись `id=event_ID_2` обновляется на `status=2` |
| 2      | Отправить запрос `DescribeDeviceV1` с параметрами:<br />`deviceId: deviceId_1`                                                                           | Пришел ответ `DescribeDeviceV1Response`:<br />`value {id: deviceId_1, platform: 'android', userId: 2, enteredAt: ± time_dev_1}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

### Тест 1.3. Удаление существующего устройства и просмотр удаленного устройства

Предв. условия: устройство создано (выполнен Тест 1.1 - Создание устройства)

| Шаг | Действие                                                                                                                             | Ожидаемый результат                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ------ | -------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1      | Отправить запрос `RemoveDeviceV1` для удаления устройства из теста 1.1:<br />`id: deviceId_1` | Пришел ответ `RemoveDeviceV1Response`:<br />`found: True`<br />- В БД в табл. `devices` обновлена запись `id=deviceId_1`: `removed=True`<br />- В БД в табл. `devices_events` появилась запись: `id={int} (event_ID_3), device_id=deviceId_1, type=3, status=1, payload={JSON}, created_at >= Текущее время (time_dev_3), updated_at >= created_at`<br />- После отправки события в Kafka  в табл. `devices_events` запись `id=event_ID_3` обновляется на `status=2` |
| 2      | Отправить запрос `DescribeDeviceV1` с параметрами:<br />`deviceId: deviceId_1`                               | Пришел ответ `DescribeDeviceV1Response` (с кодом 404):<br />`value {code: 5, message: 'device not found'}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

### Тест 1.4. Просмотр списка устройств

Предв. условия: в БД есть как минимум одно удаленное устройство (выполнен Тест 1.3 - Удаление существующего устройства)

| Шаг | Действие                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Ожидаемый результат                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1      | **Если в БД есть как минимум три существующих (не удаленных) устройства,<br />то данный шаг можно пропустить в случае срочности*<br />- Иначе необходимо создать три устройства. Для этого выполнить 2 раза <br />`CreateDeviceV1` со след. параметрами:<br />`userId: 3, platform: 'ios'`<br />`userId: 4, platform: 'android'`<br />`userId: 5, platform: 'android'` | - Пришли ответы `CreateDeviceV1Response` с устройствами:<br />`deviceId: {int} (deviceId_2)`<br />`deviceId: {int} (deviceId_3)`<br />`deviceId: {int} (deviceId_4)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| 2      | Отправить запросы `ListDevicesV1`:<br />`page: 1, per_page: 2`<br />`page: 2, per_page: 2`<br />`page: 3, per_page: 2`                                                                                                                                                                                                                                                                                                                                                                                                                | - Устройства сортируются по дате создания, сначала более новые<br />- Пришел первый ответ `ListDevicesV1Response`:<br />`items:`<br />`{id: deviceId_4, platform: 'android', userId: 5, enteredAt: ± {Текущее время} (time_dev_4)}`<br />`items:`<br />`{id: deviceId_3, platform: 'android', userId: 4, enteredAt: {time} (time_dev_5) < time_dev_4}`<br />- Пришел второй ответ `ListDevicesV1Response`:<br />`items:`<br />`{id: deviceId_2, platform: 'ios', userId: 3, enteredAt: ± {time} (time_dev_6) < time_dev_5}`<br />- Пришел третий ответ `ListDevicesV1Response` с пустым содержимым<br /><br />(В системе ответ приходит отдельными устройствами, однако по ТЗ<br />должен приходить массив - уточнить у аналитика)<br />* Если шаг 1 был пропущен, то должны отобразиться ранее созданные<br />не удаленные устройства из БД |

* Учтен риск Т (Часто меняющиеся требования), при необходимости срочного тестирования в последнюю минуту перед релизом

## 2. ActNotificationApiService

### Тест 2.1. Отправка уведомления на существующее устройство

| Шаг | Действие                                                                                                                                                                                                                                                                                                                                                                                  | Ожидаемый результат                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1      | * Если в БД есть не удаленное устройство,<br />то данный шаг можно пропустить в случае срочности<br />- Иначе необходимо создать устройство. Для этого выполнить<br />`CreateDeviceV1` со след. параметрами:<br />`userId: 1, platform: 'ios'` | - Пришел ответ `CreateDeviceV1Response`:<br />`deviceId: {int} (deviceId_5)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 2      | Отправить запрос `SendNotificationV1`:<br />`notification:` <br />`{deviceId: deviceId_5, message: 'Order is ready', `<br />`lang: '{LANG}', notificationStatus: 'STATUS_CREATED'}`<br />! Возможные значения LANG и LANG_ID см. в табл. ниже                                                                                                | - Пришел ответ `SendNotificationV1Response`:<br />`notificationId: {int} (notif_ID_1)`<br />- В БД в табл. `notification_events` создана запись:<br />`id={int} (notif_event_ID_1), device_id=deviceId_5, message='{Greetings}, Order is ready', `<br />`lang={LANG_ID}, status=1, payload={JSON}, created_at >= {Текущее время}, updated_at >= created_at`<br />! {Greetings} принимает значения в зависимости от языка и времени отправки:<br />Утро (6-11), День (11-15), Вечер (15-21), Ночь 1 и 2 (21-24, 0-6). См. ниже |

* Учтен риск Т (Часто меняющиеся требования), при необходимости срочного тестирования в последнюю минуту перед релизом

**Список комбинаций для тестирования {Greetings} по классам эквивалентности** * 

| LANG         | Время отправки, UTC+3 | Ожидаемое значение {Greetings} |
| ------------ | ---------------------------------- | ----------------------------------------------- |
| LANG_ESPANOL | 10                                 | Buenos dias                                     |
| LANG_RUSSIAN | 13                                 | Добрый день                           |
| LANG_ENGLISH | 17                                 | Good evening                                    |
| LANG_ITALIAN | 22                                 | Buona notte                                     |
| LANG_RUSSIAN | 3                                  | Доброй ночи                           |

* Границы классов вынесены в расширенный тест-план, т.к. учтен риск Т (часто меняющиеся требования)

**Соответствие между LANG и значением в БД**

| LANG         | LANG_ID - Значение в БД |
| ------------ | ----------------------------------- |
| LANG_ENGLISH | 1                                   |
| LANG_RUSSIAN | 2                                   |
| LANG_ESPANOL | 3                                   |
| LANG_ITALIAN | 4                                   |

**Greetings - Утро**

| LANG         | Greetings             |
| ------------ | --------------------- |
| LANG_ENGLISH | Good morning          |
| LANG_RUSSIAN | Доброе утро |
| LANG_ESPANOL | Buenos dias           |
| LANG_ITALIAN | Buon giorno           |

**Greetings - День**

| LANG         | Greetings             |
| ------------ | --------------------- |
| LANG_ENGLISH | Good afternoon        |
| LANG_RUSSIAN | Добрый день |
| LANG_ESPANOL | Buenas tardes         |
| LANG_ITALIAN | Buon pomeriggio       |

**Greetings - Вечер**

| LANG         | Greetings               |
| ------------ | ----------------------- |
| LANG_ENGLISH | Good evening            |
| LANG_RUSSIAN | Добрый вечер |
| LANG_ESPANOL | Buenas noches           |
| LANG_ITALIAN | Buona serata            |

**Greetings - Ночь**

| LANG         | Greetings             |
| ------------ | --------------------- |
| LANG_ENGLISH | Good night            |
| LANG_RUSSIAN | Доброй ночи |
| LANG_ESPANOL | Buenas noches         |
| LANG_ITALIAN | Buona notte           |

### Тест 2.2. Получение уведомления

Предв. условия: уведомление отправлено (выполнен Тест 2.1 - Отправка уведомления)

| Шаг | Действие                                                                   | Ожидаемый результат                                                                                                                                                                                                                                              |
| ------ | ---------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1      | Отправить запрос `GetNotification`:<br />`deviceId: deviceId_5` | - Пришел ответ `GetNotificationV1Response`:<br />`notification={[]{notificationId: notif_ID_1, message:{Greetings}, Order is ready}}`<br />- В БД в табл. `notification_events` обновлена запись `id = notif_event_ID_1`: `status=2` |

### Тест 2.3. Подтверждение получения уведомления

Предв. условия: уведомление получено (выполнен Тест 2.2 - Получение уведомления)

| Шаг | Действие                                                                         | Ожидаемый результат                                                                                                                                                                             |
| ------ | ---------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1      | Выполнить запрос `AckNotification`<br />`notificationId: notif_ID_1` | - Получен ответ `AckNotificationV1Response`:<br />`success: True`<br />- В БД в табл. `notification_events` обновлена запись `id = notif_event_ID_1`: `status=3` |

### Тест 2.4. Подписка на получение уведомлений

| Шаг | Действие                                                                                                                                                                                                                                                                                                                                                                                  | Ожидаемый результат                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1      | * Если в БД есть не удаленное устройство,<br />то данный шаг можно пропустить в случае срочности<br />- Иначе необходимо создать устройство. Для этого<br />выполнить `CreateDeviceV1` со след. параметрами:<br />`userId: 1, platform: 'ios'` | - Пришел ответ `CreateDeviceV1Response`:<br />`deviceId: {int} (deviceId_6)`                                                                                                                                                                                                                                                                                                                                                                                |
| 2      | Отправить 13 запросов `SendNotificationV1`:<br />`notification:`<br />`{deviceId: deviceId_6, message: 'Sent before subscription', `<br />`lang: 'LANG_ENGLISH', notificationStatus: 'STATUS_CREATED'}`                                                                                                                                                                 | - Пришло 13 ответов `SendNotificationV1Response`:<br />`notificationId: {int} (notif_ID_2 ... notif_ID_14)`<br />- В БД в табл. `notification_events` создано 13 записей со статусом `status=1`                                                                                                                                                                                                                    |
| 3      | Выполнить запрос `SubscribeNotification`:<br />`deviceId: deviceId_6`                                                                                                                                                                                                                                                                                                         | - Уведомления приходят в открытую сессию пачками по 10 шт.,т.е.<br />1-ая пачка - 10 шт., 2-ая пачка - 3 шт. (сортировка - сначала старые):<br />`result={[]{notificationId: notif_ID_2...14, message:{Greetings}, Sent before subscription}}`<br />- В БД в табл. `notification_events` обновлены записи `id = (notif_ID_2 ... 14)`: `status=2` |
| 4      | Отправить запрос `SendNotificationV1`:<br />`notification:`<br />`{deviceId: deviceId_6, message: 'Sent after subscription',`<br />`lang: 'LANG_ENGLISH', notificationStatus: 'STATUS_CREATED'}`                                                                                                                                                                           | - Пришел ответ `SendNotificationV1Response`:<br />`notificationId: {int} (notif_ID_15)`<br />- В открытую сессию подписчика пришло уведомление:<br />`result={[]{notificationId: notif_ID_15, message:{Greetings}, Sent after subscription}}`<br />- В БД в табл. `notification_events` создана запись для `notif_ID_15` со статусом `status=2`                       |
| 5      | Закрыть сессию подписчика                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 6      | Подтвердить получение уведомлений.<br />Выполнить `AckNotification` для каждого уведомления:<br />`notificationId: notif_ID_2...4`                                                                                                                                                                                              | - Получено 3 ответа `AckNotificationV1Response`:<br />`success: True`<br />- В БД в табл. `notification_events` обновлены записи `id = notif_event_ID_2...4`: `status=3`                                                                                                                                                                                                                                                |
| 7      | Открыть сессию. Выполнить запрос `SubscribeNotification`:<br />`deviceId: deviceId_6`                                                                                                                                                                                                                                                                           | - Пришло 10 неподтвержденных уведомлений (`status!=3`):<br />`result={[]{notificationId: notif_ID_5...14, message:{Greetings}, Sent before subscription}}`<br />- В БД в табл. `notification_events` статус записей `id = (notif_ID_5 ... 14)` прежний: `status=2`                                                                                                                                 |

* Учтен риск Т (Часто меняющиеся требования), при необходимости срочного тестирования в последнюю минуту перед релизом
